#!/usr/bin/env python3

__author__ = 'Frederic Escudie'
__copyright__ = 'Copyright (C) 2020 IUCT-O'
__license__ = 'GNU General Public License'
__version__ = '1.0.0'
__email__ = 'escudie.frederic@iuct-oncopole.fr'
__status__ = 'prod'

import os
import sys
import uuid
import tempfile
import unittest
import subprocess

CURRENT_DIR = os.path.dirname(os.path.abspath(__file__))
BIN_DIR = os.path.dirname(CURRENT_DIR)
sys.path.append(BIN_DIR)

os.environ['PATH'] = BIN_DIR + os.pathsep + os.environ['PATH']


########################################################################
#
# FUNCTIONS
#
########################################################################
class TestNormalizeBND(unittest.TestCase):
    def setUp(self):
        tmp_folder = tempfile.gettempdir()
        unique_id = str(uuid.uuid1())
        self.tmp_genome = os.path.join(tmp_folder, unique_id + "_in.fa")
        self.tmp_fai = os.path.join(tmp_folder, unique_id + "_in.fai")
        self.tmp_in = os.path.join(tmp_folder, unique_id + "_in.vcf")
        self.tmp_out = os.path.join(tmp_folder, unique_id + "_out.vcf")
        self.cmd = [
            "normalizeBND.py",
            "--input-genome", self.tmp_genome,
            "--input-variants", self.tmp_in,
            "--output-variants", self.tmp_out
        ]
        with open(self.tmp_in, "w") as writer:
            writer.write("""##fileformat=VCFv4.3
##INFO=<ID=MATEID,Number=A,Type=String,Description="ID of mate breakend.">
##INFO=<ID=RNA_FIRST,Number=0,Type=Flag,Description="For RNA fusions, this break-end is 5' in the fusion transcript.">
##INFO=<ID=SVTYPE,Number=1,Type=String,Description="Type of structural variant.">
#CHROM	POS	ID	REF	ALT	QUAL	FILTER	INFO
# +-, uncertain, no move
9	130714454	MantaBND:2:0:1:0:0:0:1	T	T]1:25918294]	.	PASS	MATEID=MantaBND%3A2%3A0%3A1%3A0%3A0%3A0%3A0;RNA_FIRST;SVTYPE=BND
1	25918293	MantaBND:2:0:1:0:0:0:0	G	G]9:130714455]	.	PASS	MATEID=MantaBND%3A2%3A0%3A1%3A0%3A0%3A0%3A1;SVTYPE=BND
# --, uncertain, extend
17	3824348	3d63ff4d-7238-4f17-a1ef-f9c1014989a5	N	]1:150811477]N	.	PASS	MATEID=b7d4e3fc-8962-47bb-8786-2d3a23a6f6bd;RNA_FIRST;SVTYPE=BND
1	150811477	b7d4e3fc-8962-47bb-8786-2d3a23a6f6bd	N	N[17:3824348[	.	PASS	MATEID=3d63ff4d-7238-4f17-a1ef-f9c1014989a5;SVTYPE=BND
# --, uncertain, move to up
5	158934311	64ce989a-1a96-497b-b522-88e7dfb32640	N	]1:150811478]N	.	PASS	MATEID=81af2743-373f-4310-b4c4-6402b03b78e9;RNA_FIRST;SVTYPE=BND
1	150811478	81af2743-373f-4310-b4c4-6402b03b78e9	N	N[5:158934311[	.	PASS	MATEID=64ce989a-1a96-497b-b522-88e7dfb32640;SVTYPE=BND
# +-, uncertain, move to up
21	8216940	8df2a5e2-fd7e-474b-a4e8-73b3939607ad	N	N]1:154171611]	.	PASS	MATEID=ea09c70c-4fa3-46a6-ba11-40132671d0bb;RNA_FIRST;SVTYPE=BND
1	154171611	ea09c70c-4fa3-46a6-ba11-40132671d0bb	N	N]21:8216940]	.	PASS	MATEID=8df2a5e2-fd7e-474b-a4e8-73b3939607ad;SVTYPE=BND
# -+, precise, no move
1	154173539	be485319-0082-4d0a-a976-794b7fd42d53	N	[5:177256951[N	.	PASS	MATEID=4997ab9e-9ee7-4b74-8348-dca268f14b40;RNA_FIRST;SVTYPE=BND
5	177256951	4997ab9e-9ee7-4b74-8348-dca268f14b40	N	[1:154173539[N	.	PASS	MATEID=be485319-0082-4d0a-a976-794b7fd42d53;SVTYPE=BND
# --, uncertain, move to down
X	1536921	8766c3af-c709-44ea-bb19-a3827335178f	N	]11:118781184]N	.	PASS	MATEID=892b1955-cf67-4a05-ab04-baa4709f07e1;RNA_FIRST;SVTYPE=BND
11	118781184	892b1955-cf67-4a05-ab04-baa4709f07e1	N	N[X:1536921[	.	PASS	MATEID=8766c3af-c709-44ea-bb19-a3827335178f;SVTYPE=BND
# ++, uncertain, move to down
22	41179875	c0dce868-0a1e-4dd3-ab7f-89937d83e680	N	N[12:26649201[	.	PASS	MATEID=de463e53-7c19-438f-afd8-c10a6079b368;RNA_FIRST;SVTYPE=BND
12	26649201	de463e53-7c19-438f-afd8-c10a6079b368	N	]22:41179875]N	.	PASS	MATEID=c0dce868-0a1e-4dd3-ab7f-89937d83e680;SVTYPE=BND
# -+, uncertain, move to down
16	3738559	d049c3ea-08f6-4f84-8ab4-053febff5112	N	[22:41172499[N	.	PASS	MATEID=608d1a12-8fff-4bd1-b520-9a1fbf5a6962;RNA_FIRST;SVTYPE=BND
22	41172499	608d1a12-8fff-4bd1-b520-9a1fbf5a6962	N	[16:3738559[N	.	PASS	MATEID=d049c3ea-08f6-4f84-8ab4-053febff5112;SVTYPE=BND
# +-, uncertain, extend
22	41158500	0162d4c4-a448-4039-8246-ef0d82a4e930	N	N]16:3751806]	.	PASS	MATEID=d3692b46-d825-475e-9c48-65cb3fe39b7c;RNA_FIRST;SVTYPE=BND
16	3751806	d3692b46-d825-475e-9c48-65cb3fe39b7c	N	N]22:41158500]	.	PASS	MATEID=0162d4c4-a448-4039-8246-ef0d82a4e930;SVTYPE=BND
# -+, uncertain, extend
17	1650592	38f07548-1cab-4114-8edf-5fede620a809	N	[17:80263574[N	.	PASS	MATEID=c7b27813-7a41-439a-8b49-3512766c2e1f;RNA_FIRST;SVTYPE=BND
17	80263574	c7b27813-7a41-439a-8b49-3512766c2e1f	N	[17:1650592[N	.	PASS	MATEID=38f07548-1cab-4114-8edf-5fede620a809;SVTYPE=BND
# -+, uncertain, move to up
17	81682443	6a890285-a791-4127-8d22-8115e0a0712f	N	[17:20204333[N	.	PASS	MATEID=24663b3b-26e6-42f7-9fd3-ce6fd589320b;RNA_FIRST;SVTYPE=BND
17	20204333	24663b3b-26e6-42f7-9fd3-ce6fd589320b	N	[17:81682443[N	.	PASS	MATEID=6a890285-a791-4127-8d22-8115e0a0712f;SVTYPE=BND
# ++, uncertain, move to up
21	8258523	fbefa388-ee78-471e-a48b-53ed2fef18f4	N	N[17:59660391[	.	PASS	MATEID=c70c4839-b235-4e99-91da-36c948460a11;RNA_FIRST;SVTYPE=BND
17	59660391	c70c4839-b235-4e99-91da-36c948460a11	N	]21:8258523]N	.	PASS	MATEID=fbefa388-ee78-471e-a48b-53ed2fef18f4;SVTYPE=BND
# +-, precise, no move
17	80334636	07b71157-bb54-4ab2-87e8-4f71600f4507	N	N]3:177024730]	.	PASS	MATEID=f45674e1-3fdf-432f-a10b-34a162591b92;RNA_FIRST;SVTYPE=BND
3	177024730	f45674e1-3fdf-432f-a10b-34a162591b92	N	N]17:80334636]	.	PASS	MATEID=07b71157-bb54-4ab2-87e8-4f71600f4507;SVTYPE=BND
# ++, precise, no move
17	80373857	25fb8488-4d1f-4501-a292-c13ee3c15def	N	N[9:121115086[	.	PASS	MATEID=1b11b081-4641-42b4-a5f8-718421f51591;RNA_FIRST;SVTYPE=BND
9	121115086	1b11b081-4641-42b4-a5f8-718421f51591	N	]17:80373857]N	.	PASS	MATEID=25fb8488-4d1f-4501-a292-c13ee3c15def;SVTYPE=BND
# ++, uncertain, extend
19	16095893	29d287e8-5a6c-47e5-b465-ac0bcb5c0e7b	N	N[5:177256951[	.	PASS	MATEID=c4971697-4c9d-456e-80f6-d3f5d2107f11;RNA_FIRST;SVTYPE=BND
5	177256951	c4971697-4c9d-456e-80f6-d3f5d2107f11	N	]19:16095893]N	.	PASS	MATEID=29d287e8-5a6c-47e5-b465-ac0bcb5c0e7b;SVTYPE=BND
# +-, uncertain, move to down
22	41179871	438e2187-2e71-4ebe-beec-6b275dc4a45b	N	N]2:89321704]	.	PASS	MATEID=f77d3a46-4532-4f82-9223-ba4adc33ef68;RNA_FIRST;SVTYPE=BND
2	89321704	f77d3a46-4532-4f82-9223-ba4adc33ef68	N	N]22:41179871]	.	PASS	MATEID=438e2187-2e71-4ebe-beec-6b275dc4a45b;SVTYPE=BND
# ++, uncertain, no move
20	41101350	MantaBND:288:3:6:0:0:0:0	C	C[20:41092469[	.	PASS	MATEID=MantaBND%3A288%3A3%3A6%3A0%3A0%3A0%3A1;RNA_FIRST;SVTYPE=BND
20	41092469	MantaBND:288:3:6:0:0:0:1	A	]20:41101350]A	.	PASS	MATEID=MantaBND%3A288%3A3%3A6%3A0%3A0%3A0%3A0;SVTYPE=BND
# --, uncertain, no move
21	34834409	MantaBND:310:0:6:0:2:0:1	C	]21:34859577]C	.	PASS	MATEID=MantaBND%3A310%3A0%3A6%3A0%3A2%3A0%3A0;RNA_FIRST;SVTYPE=BND
21	34859577	MantaBND:310:0:6:0:2:0:0	C	C[21:34834409[	.	PASS	MATEID=MantaBND%3A310%3A0%3A6%3A0%3A2%3A0%3A1;SVTYPE=BND
# ++, precise, no move
21	34859474	MantaBND:310:0:2:0:2:0:1	T	]8:92017363]T	.	PASS	MATEID=MantaBND%3A310%3A0%3A2%3A0%3A2%3A0%3A0;RNA_FIRST;SVTYPE=BND
8	92017363	MantaBND:310:0:2:0:2:0:0	T	T[21:34859474[	.	PASS	MATEID=MantaBND%3A310%3A0%3A2%3A0%3A2%3A0%3A1;SVTYPE=BND
# IMPRECISE with CIPOS and known ref and alt
8	25399040	MantaBND:288:11:13:0:0:0:1	A	[7:50402680[A	.	PASS	CIPOS=-19,20;IMPRECISE;MATEID=MantaBND%3A288%3A11%3A13%3A0%3A0%3A0%3A0;RNA_FIRST;SVTYPE=BND
7	50402680	MantaBND:288:11:13:0:0:0:0	T	[8:25399040[T	.	PASS	CIPOS=-19,20;IMPRECISE;MATEID=MantaBND%3A288%3A11%3A13%3A0%3A0%3A0%3A1;SVTYPE=BND
# IMPRECISE without CIPOS and unknown ref and alt
8	38299494	a258abe3-31e6-483b-b463-fcca36cc848f	N	]7:92614584]N	.	PASS	IMPRECISE;MATEID=2c4739b6-b750-4c5e-b10a-491538aae408;RNA_FIRST;SVTYPE=BND
7	92614584	2c4739b6-b750-4c5e-b10a-491538aae408	N	N[8:38299494[	.	PASS	IMPRECISE;MATEID=a258abe3-31e6-483b-b463-fcca36cc848f;SVTYPE=BND""")
        self.expected = """##fileformat=VCFv4.1
##INFO=<ID=CIPOS,Number=2,Type=Integer,Description="Confidence interval around POS for variants.">
##INFO=<ID=IMPRECISE,Number=0,Type=Flag,Description="Imprecise structural variation.">
##INFO=<ID=MATEID,Number=A,Type=String,Description="ID of mate breakend.">
##INFO=<ID=RNA_FIRST,Number=0,Type=Flag,Description="For RNA fusions, this break-end is 5' in the fusion transcript.">
##INFO=<ID=SVTYPE,Number=1,Type=String,Description="Type of structural variant.">
#CHROM	POS	ID	REF	ALT	QUAL	FILTER	INFO
9	130714454	MantaBND:2:0:1:0:0:0:1	T	T]1:25918294]	.	PASS	CIPOS=0,1;MATEID=MantaBND%3A2%3A0%3A1%3A0%3A0%3A0%3A0;RNA_FIRST;SVTYPE=BND
1	25918293	MantaBND:2:0:1:0:0:0:0	G	G]9:130714455]	.	PASS	CIPOS=0,1;MATEID=MantaBND%3A2%3A0%3A1%3A0%3A0%3A0%3A1;SVTYPE=BND
17	3824344	3d63ff4d-7238-4f17-a1ef-f9c1014989a5	A	]1:150811473]C	.	PASS	CIPOS=0,5;MATEID=b7d4e3fc-8962-47bb-8786-2d3a23a6f6bd;RNA_FIRST;SVTYPE=BND
1	150811473	b7d4e3fc-8962-47bb-8786-2d3a23a6f6bd	C	A[17:3824344[	.	PASS	CIPOS=0,5;MATEID=3d63ff4d-7238-4f17-a1ef-f9c1014989a5;SVTYPE=BND
5	158934308	64ce989a-1a96-497b-b522-88e7dfb32640	A	]1:150811475]C	.	PASS	CIPOS=0,3;MATEID=81af2743-373f-4310-b4c4-6402b03b78e9;RNA_FIRST;SVTYPE=BND
1	150811475	81af2743-373f-4310-b4c4-6402b03b78e9	C	A[5:158934308[	.	PASS	CIPOS=0,3;MATEID=64ce989a-1a96-497b-b522-88e7dfb32640;SVTYPE=BND
21	8216935	8df2a5e2-fd7e-474b-a4e8-73b3939607ad	C	A]1:154171616]	.	PASS	CIPOS=0,5;MATEID=ea09c70c-4fa3-46a6-ba11-40132671d0bb;RNA_FIRST;SVTYPE=BND
1	154171611	ea09c70c-4fa3-46a6-ba11-40132671d0bb	A	T]21:8216940]	.	PASS	CIPOS=0,5;MATEID=8df2a5e2-fd7e-474b-a4e8-73b3939607ad;SVTYPE=BND
1	154173539	be485319-0082-4d0a-a976-794b7fd42d53	C	[5:177256951[G	.	PASS	MATEID=4997ab9e-9ee7-4b74-8348-dca268f14b40;RNA_FIRST;SVTYPE=BND
5	177256951	4997ab9e-9ee7-4b74-8348-dca268f14b40	G	[1:154173539[C	.	PASS	MATEID=be485319-0082-4d0a-a976-794b7fd42d53;SVTYPE=BND
X	1536921	8766c3af-c709-44ea-bb19-a3827335178f	C	]11:118781184]T	.	PASS	CIPOS=0,2;MATEID=892b1955-cf67-4a05-ab04-baa4709f07e1;RNA_FIRST;SVTYPE=BND
11	118781184	892b1955-cf67-4a05-ab04-baa4709f07e1	T	C[X:1536921[	.	PASS	CIPOS=0,2;MATEID=8766c3af-c709-44ea-bb19-a3827335178f;SVTYPE=BND
22	41179875	c0dce868-0a1e-4dd3-ab7f-89937d83e680	C	C[12:26649201[	.	PASS	CIPOS=0,2;MATEID=de463e53-7c19-438f-afd8-c10a6079b368;RNA_FIRST;SVTYPE=BND
12	26649201	de463e53-7c19-438f-afd8-c10a6079b368	C	]22:41179875]C	.	PASS	CIPOS=0,2;MATEID=c0dce868-0a1e-4dd3-ab7f-89937d83e680;SVTYPE=BND
16	3738559	d049c3ea-08f6-4f84-8ab4-053febff5112	C	[22:41172499[G	.	PASS	CIPOS=0,1;MATEID=608d1a12-8fff-4bd1-b520-9a1fbf5a6962;RNA_FIRST;SVTYPE=BND
22	41172498	608d1a12-8fff-4bd1-b520-9a1fbf5a6962	G	[16:3738560[C	.	PASS	CIPOS=0,1;MATEID=d049c3ea-08f6-4f84-8ab4-053febff5112;SVTYPE=BND
22	41158496	0162d4c4-a448-4039-8246-ef0d82a4e930	A	T]16:3751810]	.	PASS	CIPOS=0,7;MATEID=d3692b46-d825-475e-9c48-65cb3fe39b7c;RNA_FIRST;SVTYPE=BND
16	3751803	d3692b46-d825-475e-9c48-65cb3fe39b7c	A	A]22:41158503]	.	PASS	CIPOS=0,7;MATEID=0162d4c4-a448-4039-8246-ef0d82a4e930;SVTYPE=BND
17	1650591	38f07548-1cab-4114-8edf-5fede620a809	G	[17:80263575[A	.	PASS	CIPOS=0,2;MATEID=c7b27813-7a41-439a-8b49-3512766c2e1f;RNA_FIRST;SVTYPE=BND
17	80263573	c7b27813-7a41-439a-8b49-3512766c2e1f	G	[17:1650593[T	.	PASS	CIPOS=0,2;MATEID=38f07548-1cab-4114-8edf-5fede620a809;SVTYPE=BND
17	81682441	6a890285-a791-4127-8d22-8115e0a0712f	A	[17:20204335[G	.	PASS	CIPOS=0,2;MATEID=24663b3b-26e6-42f7-9fd3-ce6fd589320b;RNA_FIRST;SVTYPE=BND
17	20204333	24663b3b-26e6-42f7-9fd3-ce6fd589320b	G	[17:81682443[C	.	PASS	CIPOS=0,2;MATEID=6a890285-a791-4127-8d22-8115e0a0712f;SVTYPE=BND
21	8258522	fbefa388-ee78-471e-a48b-53ed2fef18f4	C	G[17:59660390[	.	PASS	CIPOS=0,1;MATEID=c70c4839-b235-4e99-91da-36c948460a11;RNA_FIRST;SVTYPE=BND
17	59660390	c70c4839-b235-4e99-91da-36c948460a11	G	]21:8258522]C	.	PASS	CIPOS=0,1;MATEID=fbefa388-ee78-471e-a48b-53ed2fef18f4;SVTYPE=BND
17	80334636	07b71157-bb54-4ab2-87e8-4f71600f4507	T	A]3:177024730]	.	PASS	MATEID=f45674e1-3fdf-432f-a10b-34a162591b92;RNA_FIRST;SVTYPE=BND
3	177024730	f45674e1-3fdf-432f-a10b-34a162591b92	A	T]17:80334636]	.	PASS	MATEID=07b71157-bb54-4ab2-87e8-4f71600f4507;SVTYPE=BND
17	80373857	25fb8488-4d1f-4501-a292-c13ee3c15def	G	T[9:121115086[	.	PASS	MATEID=1b11b081-4641-42b4-a5f8-718421f51591;RNA_FIRST;SVTYPE=BND
9	121115086	1b11b081-4641-42b4-a5f8-718421f51591	T	]17:80373857]G	.	PASS	MATEID=25fb8488-4d1f-4501-a292-c13ee3c15def;SVTYPE=BND
19	16095890	29d287e8-5a6c-47e5-b465-ac0bcb5c0e7b	A	C[5:177256948[	.	PASS	CIPOS=0,4;MATEID=c4971697-4c9d-456e-80f6-d3f5d2107f11;RNA_FIRST;SVTYPE=BND
5	177256948	c4971697-4c9d-456e-80f6-d3f5d2107f11	C	]19:16095890]A	.	PASS	CIPOS=0,4;MATEID=29d287e8-5a6c-47e5-b465-ac0bcb5c0e7b;SVTYPE=BND
22	41179871	438e2187-2e71-4ebe-beec-6b275dc4a45b	A	G]2:89321704]	.	PASS	CIPOS=0,6;MATEID=f77d3a46-4532-4f82-9223-ba4adc33ef68;RNA_FIRST;SVTYPE=BND
2	89321698	f77d3a46-4532-4f82-9223-ba4adc33ef68	G	C]22:41179877]	.	PASS	CIPOS=0,6;MATEID=438e2187-2e71-4ebe-beec-6b275dc4a45b;SVTYPE=BND
20	41101350	MantaBND:288:3:6:0:0:0:0	C	A[20:41092469[	.	PASS	CIPOS=0,5;MATEID=MantaBND%3A288%3A3%3A6%3A0%3A0%3A0%3A1;RNA_FIRST;SVTYPE=BND
20	41092469	MantaBND:288:3:6:0:0:0:1	A	]20:41101350]C	.	PASS	CIPOS=0,5;MATEID=MantaBND%3A288%3A3%3A6%3A0%3A0%3A0%3A0;SVTYPE=BND
21	34834409	MantaBND:310:0:6:0:2:0:1	C	]21:34859577]C	.	PASS	CIPOS=0,2;MATEID=MantaBND%3A310%3A0%3A6%3A0%3A2%3A0%3A0;RNA_FIRST;SVTYPE=BND
21	34859577	MantaBND:310:0:6:0:2:0:0	C	C[21:34834409[	.	PASS	CIPOS=0,2;MATEID=MantaBND%3A310%3A0%3A6%3A0%3A2%3A0%3A1;SVTYPE=BND
21	34859474	MantaBND:310:0:2:0:2:0:1	T	]8:92017363]T	.	PASS	MATEID=MantaBND%3A310%3A0%3A2%3A0%3A2%3A0%3A0;RNA_FIRST;SVTYPE=BND
8	92017363	MantaBND:310:0:2:0:2:0:0	T	T[21:34859474[	.	PASS	MATEID=MantaBND%3A310%3A0%3A2%3A0%3A2%3A0%3A1;SVTYPE=BND
8	25399040	MantaBND:288:11:13:0:0:0:1	A	[7:50402680[A	.	PASS	CIPOS=-19,20;IMPRECISE;MATEID=MantaBND%3A288%3A11%3A13%3A0%3A0%3A0%3A0;RNA_FIRST;SVTYPE=BND
7	50402680	MantaBND:288:11:13:0:0:0:0	T	[8:25399040[T	.	PASS	CIPOS=-19,20;IMPRECISE;MATEID=MantaBND%3A288%3A11%3A13%3A0%3A0%3A0%3A1;SVTYPE=BND
8	38299494	a258abe3-31e6-483b-b463-fcca36cc848f	T	]7:92614584]A	.	PASS	IMPRECISE;MATEID=2c4739b6-b750-4c5e-b10a-491538aae408;RNA_FIRST;SVTYPE=BND
7	92614584	2c4739b6-b750-4c5e-b10a-491538aae408	A	T[8:38299494[	.	PASS	IMPRECISE;MATEID=a258abe3-31e6-483b-b463-fcca36cc848f;SVTYPE=BND"""

    def tearDown(self):
        # Clean temporary files
        for curr_file in [self.tmp_in, self.tmp_out, self.tmp_genome, self.tmp_fai]:
            if os.path.exists(curr_file):
                os.remove(curr_file)

    def testExec(self):
        pass
        # # Execute command
        # subprocess.check_call(self.cmd, stderr=subprocess.DEVNULL)
        # # Compare
        # observed = []
        # with open(self.tmp_out) as reader:
        #     observed = reader.read().strip()
        # for curr_exp, curr_obs in zip(self.expected.split("\n"), observed.split("\n")):
        #     self.assertEqual(curr_exp, curr_obs)


########################################################################
#
# MAIN
#
########################################################################
if __name__ == "__main__":
    unittest.main()
